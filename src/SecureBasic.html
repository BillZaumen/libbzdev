<!DOCTYPE HTML>
<HTML lang="en">
<HEAD>
  <title>Secure Basic Authentication</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="../stylesheet.css">
</HEAD>
<BODY>
  <H1>Secure Basic Authentication</H1>
  <P> 
    <STRONG>Basic Access Authentication</STRONG> and a more secure
    variant named <STRONG>Digest Access Authentication</STRONG>, are
    described in RFC 2617, which discusses the security issues with
    both, including MITM (Man In The Middle) attacks.
  <P>
    Secure Basic authentication combines the simplicity of Basic
    authentication with the security provided by public-key
    cryptography.  Simplicity is achieved by eliminating the need for
    a server to explicitly send a challenge as is done by SSH or FIDO
    when public-key authentication is used.  Instead, a short-lived
    password is computed, using a combination of time stamps and public
    key encryption, and verified by the server.
    Secure basic authentication assumes that SSL/TLS will be used for
    connections between a client and server. Aa a result,
    <UL>
      <LI> when a connection is first established, a client will receive
	a certificate from the server. This certificate is valid for at
	least the duration of the connection.
      <LI> the certificate is used to verify that the server to which
	the client has connected in fact has the private key corresponding
	to the public key stored in the certificate.
      <LI> servers are implemented so that the private keys are kept
	securely.  As a result, any attempt a pfishing or spoofing will
	require the use of a different certificate, and specifically a
	different public key.
    </UL>
    The short-lived password that secure basic authentication uses is
    generated by signing a time stamp and the server's certificate's
    public key  along with some additional information. This requires
    that the server's and client's clocks are synchronized, but that is
    easily done given that most systems use NTP (Network Time Protocol).
    Once veried, this password can be used for a more extended
    period.  If that period expired, a new short-lived password is
    generated ane revalidated.
  <P>
    The password generated in Secure Basic authentication uses
    <UL>
      <LI> a private key corresponding to the public key that will
	be stored on a server.
      <LI> a user-generated password, called the "stored password"
	below, that will be stored on the server.
      <LI> the current time.
    </UL>
    The generated password contains several fields:
    <UL>
      <LI> a 4-octet field containing a timestamp consisting of a
	32-bit two's complement integer, stored in little-endian byte
	order, providing the time the password was created. The time
	is given by the number of seconds since 1970-01-01T00:00:00Z.
      <LI> a 4-octet field containing a 32-bit CRC of the first four
	octets and a UTF-8 encoded stored password in that order, stored in
	little-endian byte order. For a denial of service attack with
	random passwords, the CRC will reduce the number of digital
	signatures that have to verified by a server by a factor of
	approximately 4 billion.
      <LI> a digital signature of
	<UL>
	  <LI> the first 8 octets,
	  <LI> the DER encoding of the certificate's public key,
	  <LI> the UTF-8 encoded stored password used in the CRC,
	</UL>
	created using the user's private key and signature algorithm.
    </UL>
    This sequence of octets is then base-64 encoded using the URL-safe
    encoding described in RFC 4648 to create the password that will be
    sent to the server.
  <P>
    The server stores the user's public key, signature algorithm, and
    stored password. To check that a password is valid, the server
    <UL>
      <LI> decodes the password using a base-64 decoder for the
	URL-safe encoding,
      <LI> checks the timestamp stored in the first four octets
	(octets 1 to 4),
      <LI> uses the first 4 octets and the stored password in that
	order to compute a 32-bit CRC and compares that to the one
	corresponding to the value stored in octets 5 to 8,
      <LI> uses the public key and signature algorithm to verify that
	the signature stored in the remaining octets (starting with
	octet 9) is valid for a document consisting of
	<UL>
	  <LI> octets 1 to 8,
	  <LI> the server's SSL certificate's public key represented
	    by its DER encoding,
	  <LI> the UTF-8 encoded stored password.
	</UL>
    </UL>
    If these tests do not fail, authorization succeeds and the
    password can be stored in a table of verified passwords with a key
    given by the user's name and Internet address. This table also
    includes an expiration time for the user and address specified by
    the key, which is updated each time the key provided the
    expiration time has not been reached.  If the expiration time has
    been passed, the authentication fails and the user must generate a
    new password.
  <P>
    In addition to providing some protection against denial of service
    attacks, The stored password is useful when certificates use
    subject alternative names, effectively allowing multiple entities
    to share a single certificate, and where one may want to be logged
    into one entity but not another.
  <P>
    Typically a client will reuse a password that it has previously
    generated until that password fails.  It that is done, the client
    should also  check that the corresponding certificate has not been
    changed: otherwise a MITM attack is possible, although that would
    require compromising the network infrastructure (routers, DNS servers,
    etc.)

    <H2>Alternative password format</H2>

    A special encoding is used to allow a user name and password to
    be entered into a browser's password text field, leaving the user
    name blank: if a password starts with a colon (':') and is followed
    by some text that is terminated by a colon, the text between those
    two colons is treated as the user name, and the text after the
    second colon then contains the password represented by its
    base-64 URL-safe encoding.

    A program, <STRONG>sbl</STRONG>, will generate passwords in this
    format and copy them to the clipboard so that they can be pasted
    into a dialog box provided by a browser that does not support
    secure basic authentication without the need to copy and paste a
    user name and password separately.

    <H2>Realms</H2>
  <P>
    Secure basic authentication uses a stylized encoding for realms: if
    a realm sent by a server to a client starts with
    <UL>
      <LI><STRONG>[D]</STRONG>, a form of digest authentication is used:
	the password is the URL-safe base64 encoding of the first 8
	octets as described above, followed by a SHA-256
	message digest of those 8 octets and the UTF-8 encoded
	password in that order. This option is provided primarily for
	testing.
      <LI><STRONG>[S]</STRONG>, the digital signature described above
	does not include the public key from the server certificate.
	This option is provided for testing or if for some
	reason SSL cannot be used and security is not a major concern.
      <LI><STRONG>[SC]</STRONG>, the digital signature is computed as
	described above.
    </UL>
    Otherwise basic authentication is assumed.  The class
    org.bzdev.swing.AuthenticationPane replaces "[D]", "[S]", and
    "[SC]" with sequences of one or more emoji when creating a prompt
    to display.  The emoji are used as icons.

    <H2>Timestamps and timeouts</H2>
  <P>
    A server should support the following limits and timeouts
    <UL>
      <LI><STRONG>lowerTimeDiffLimit</STRONG>. This value must be
	negative. It is added to the current time to get a lower bound
	on the timestamp encoded in the first 4 octets of a password.
	It is negative to account for clocks being slightly out of
	synchronization. The value is in units of seconds.
      <LI><STRONG>upperTimeDiffLimit</STRONG>. This value must not be
	negative. It is added to the current time to get an upper bound
	on the timestamp encoded in the first 4 octets of a password.
	Its value should be large enough to allow for delay and
	processing time in addition to errors in clock synchronization.
	The value is in units of seconds.
      <LI><STRONG>passwordTimeout</STRONG>. Once a password has been
	authenticated, the password will typically be kept in a table
	that maps a given user name and Internet address to a password
	and expiration time.  The expiration time will be the sum of
	the current time and the value of
	<STRONG>passwordTimeout</STRONG>, both in units of seconds.
	If a new authorization request arrives before the expiration
	time for the same user and Internet address, the corresponding
	expiration time is reset to the sum of the new current time
	and the value of
	<STRONG>passwordTimeout</STRONG>.
    </UL>
  <P>
    The use of timestamps prevents old passwords from being reused,
    even though, with SSL/TLS, it would be very difficult to obtain one.

    <H2>Key pairs</H2>

    Key pairs and signature algorithms are those that Java supports.
    The default uses elliptic key cryptography.  The elliptic curve
    is <STRONG>secp256r1</STRONG> (openssl prefers the name
    <STRONG>prime256v1</STRONG>, which keytool does not accept). The
    default signature algorithm is <STRONG>SHA256withECDSA</STRONG>.

    <H2>Ease of implementation</H2>

    Secure basic authentication is easy to implement, primarily
    because basic-authentication code is reused.  The following
    classes were added to the BZDev class library to support
    secure basic authentication:
    <UL>
      <LI><STRONG>org.bzdev.net.PemDecoder</STRONG>: 227 lines of
	code.  This is a general-purpose class for decoding PEM files.
	It uses a utility class (org.bzdev.net.HeaderOps) that
	contains 371 lines of code).
      <LI><STRONG>org.bzdev.net.PemEncoder</STRONG>: 79 lines of code.
	This is a general-purpose class for encoding PEM files.
      <LI><STRONG>org.bzdev.net.SecureBasicUtilities</STRONG>: 622
	lines of code. This class contains the code for creating and
	verifying passwords, and for some other useful operations. It
	contains methods used by both a client and a server and can
	generate key pairs. It also contains methods that allow
	passwords to be represented in a series of format: strings,
	arrays of char, and arrays of bytes, so there is more code
	than would be needed by a single application.
      <LI><STRONG>org.bzdev.ejws.EjwsSecureBasicAuth</STRONG>: 484
	lines of code, compared to 184 lines of code for
	org.bzdev.ejws.EjwsBasicAuthenticator, which provides an
	implementation of basic authentication.  The class
	EjwsSecureBasicAuth contains server-specific code for the web
	server provided by the org.bzdev.ejws package.  If a private
	key is GPG encrypted, this class will use GPG to decrypt the
	private key (the advantage is that GPG agent will then prompt
	for the appropriate password, etc., needed to decrypt the
	key).
      <LI><STRONG>org.bzdev.swing.AuthenticationPane</STRONG>: 558
	lines of code.  This contains the code needed to create a
	dialog box to get a user name and password. It works with
	secure basic authentication, digest authentication, and basic
	authentication.
    </UL>
    The number of lines of code were estimated using a program that
    ignores comments and blank lines, but counts everything else including
    Java import statements and lines that contain as little as a single
    brace. As a result the number of lines of code listed for each case
    is an overestimate of the number of executable statements.
  <P>
    Implementing secure basic authentication in a browser should be
    roughly comparable to implementing or modifying a password manager.

    <H2>Implementation limitations</H2>
  <P>
    The current implementation has two limitations, mostly because
    of the existing Java APIs:
    <UL>
      <LI> The client will open a separate SSL connection to the
        server to get the certificate because the Java APIs do not
        provide a convenient way of getting the certificate for the
        connection an authenticator is using.
      <LI> When a password is cached an SSL connection's certificate is
	not checked to verify that it is the one used to generate the
	password. While it is a trivial change, it would require modifying
	classes that are part of the JRE.
    </UL>
    <H2>Example</H2>

  <P>
    Public key:
    <BLOCKQUOTE><PRE><CODE>
signature-algorithm: SHA256withECDSA
-----BEGIN EC PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE1IC0QbQQPpt4xWzI8IHya5HEOGZu
fzjm5LztuExU2T+tvZhXRBQRewShwwoxbPUV+NZo7YHpXXHfMciMLKpzFQ==
-----END EC PUBLIC KEY-----
</CODE></PRE></BLOCKQUOTE>
  <P>
    A generated password using a Google certificate, the user name "foo",
    the stored password "foo", and the private key corresponding to the public
    key shown above is
    <BLOCKQUOTE><PRE><CODE>
ItCIZNDMkJEwRAIgTkEK43Mao0oc2WLoly3YBHw23lnAqfdcXvKXS35-jSwCIETQHL40qqL3N6UWtCH4BZsriuViBdShQlmK7wsHkZMq
</CODE></PRE></BLOCKQUOTE>
  <P>
    Similarly, a generated password using a Yahoo certificate, the
    user name "foo", the stored password "foo", and the private key
    corresponding to the public key shown above is
    <BLOCKQUOTE><PRE><CODE>
UdCIZGYGEEwwRQIgB3F8RHs48TUhtvfbCYotQdKOJk6jjUHyVTsoIn6tOWgCIQCYCqP5gJhmYiFWeTrHF8kyv2OxOlkwywI5mydaPU1hRA==
</CODE></PRE></BLOCKQUOTE>
  <P>
    Successfully verifying these passwords requires that that
    the public key can verify a signature constructed using the
    user's stored password and the server's certficate, and two
    different servers cannot use the same certificate without at
    a minimum sharing the certificate's private key..
  <P>
    For referenece, The Google certificate used was
    <BLOCKQUOTE><PRE><CODE>
-----BEGIN CERTIFICATE-----
MIIEhzCCA2+gAwIBAgIQaIqdcIkiQpQSu0HdwEZSEDANBgkqhkiG9w0BAQsFADBG
MQswCQYDVQQGEwJVUzEiMCAGA1UEChMZR29vZ2xlIFRydXN0IFNlcnZpY2VzIExM
QzETMBEGA1UEAxMKR1RTIENBIDFDMzAeFw0yMzA1MTkxMjU4MTNaFw0yMzA4MTEx
MjU4MTJaMBkxFzAVBgNVBAMTDnd3dy5nb29nbGUuY29tMFkwEwYHKoZIzj0CAQYI
KoZIzj0DAQcDQgAE5+JO07UF+YkqU7GHvvPFBFuTI4beEUeTtUrrXXDVk4/yBMA7
afFVUoiN4TF3f1iR9ZYb39ofxQeRI3ibvDcoH6OCAmcwggJjMA4GA1UdDwEB/wQE
AwIHgDATBgNVHSUEDDAKBggrBgEFBQcDATAMBgNVHRMBAf8EAjAAMB0GA1UdDgQW
BBSVxeavHNbSACqKv9drJts57JT6BzAfBgNVHSMEGDAWgBSKdH+vhc3ulc09nNDi
RhTzcTUdJzBqBggrBgEFBQcBAQReMFwwJwYIKwYBBQUHMAGGG2h0dHA6Ly9vY3Nw
LnBraS5nb29nL2d0czFjMzAxBggrBgEFBQcwAoYlaHR0cDovL3BraS5nb29nL3Jl
cG8vY2VydHMvZ3RzMWMzLmRlcjAZBgNVHREEEjAQgg53d3cuZ29vZ2xlLmNvbTAh
BgNVHSAEGjAYMAgGBmeBDAECATAMBgorBgEEAdZ5AgUDMDwGA1UdHwQ1MDMwMaAv
oC2GK2h0dHA6Ly9jcmxzLnBraS5nb29nL2d0czFjMy9mVkp4YlYtS3Rtay5jcmww
ggEEBgorBgEEAdZ5AgQCBIH1BIHyAPAAdgDoPtDaPvUGNTLnVyi8iWvJA9PL0RFr
7Otp4Xd9bQa9bgAAAYg0Tc50AAAEAwBHMEUCIHGOV17ZNpEAGeREava8cY+XozN/
QKv1zDHux8gi87lpAiEAgBf7dAkXNCSrc2m6rdPES6ouwAYm0Y/uFYxeYsF3mZAA
dgCzc3cH4YRQ+GOG1gWp3BEJSnktsWcMC4fc8AMOeTalmgAAAYg0Tc6pAAAEAwBH
MEUCIC/iBqmdZUT62MWoWhFU1QV75YI9asAb9ULHU5iU0H3QAiEA1XvfAVlBQiVK
8LcZgIAlIX6nkxY0+kVeJdZpWkYgnZAwDQYJKoZIhvcNAQELBQADggEBANBuETkw
YEBzrBXuu1hyMyOlTg2PlOjiAK3/JrJ8XxONWB9vJ3HpmKYPQa6hGtO2XlQQ4BDD
XWwmeXrLM3La9Nf4kMHM7KmhTUu6NSycINuvF4w28KxkP0y+VRNpmvm7k723xGk+
7FkjdhpAMhD7322FMZlqYV3wDRDEHaSDNZnBnTniNaWx+cXjPvlGHrYyojaZ2R7+
cQMGU++TfvGeykPton+K3CPrGA0NgohxzyqOy5x1Py3RtLrUZCHy3JuxtuX/FvlM
XDu0YAoUHfqhmBoSqWj8sHLb++c5d4AWO4rhjHFvF4/CVHkuxehKl2ytwGIZqisJ
WRhOiYq0rqjzgLQ=
-----END CERTIFICATE-----
</CODE></PRE></BLOCKQUOTE>
    and the Yahoo certificate used was
    <BLOCKQUOTE><PRE><CODE>
-----BEGIN CERTIFICATE-----
MIIHCjCCBfKgAwIBAgIQCOMVxD5bPAxsFkDF4E5b+DANBgkqhkiG9w0BAQsFADBw
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMS8wLQYDVQQDEyZEaWdpQ2VydCBTSEEyIEhpZ2ggQXNz
dXJhbmNlIFNlcnZlciBDQTAeFw0yMzA1MDIwMDAwMDBaFw0yMzEwMjUyMzU5NTla
MGcxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRIwEAYDVQQHEwlT
dW5ueXZhbGUxGzAZBgNVBAoTEk9hdGggSG9sZGluZ3MgSW5jLjESMBAGA1UEAxMJ
eWFob28uY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEBXKfj6BfY2g7WbNG
aciQoIAf/xFEh8BtJXrJmjG2Bq46d4VdRZkIFQgNC0P1Ku2t9HdjfA1bGreUyjGc
TKaOKqOCBHIwggRuMB8GA1UdIwQYMBaAFFFo/5CvAgd1PMzZZWRiohK4WXI7MB0G
A1UdDgQWBBSEIFgNJdSMvmV7RNRP+zIIyAnYUzCCATIGA1UdEQSCASkwggElggl5
YWhvby5jb22CD3R3LnJkLnlhaG9vLmNvbYIKcy55aW1nLmNvbYIMbWJwLnlpbWcu
Y29tgg9oay5yZC55YWhvby5jb22CFmZyLWNhLnJvZ2Vycy55YWhvby5jb22CEGRk
bC5mcC55YWhvby5jb22CE2NhLnJvZ2Vycy55YWhvby5jb22CD2NhLm15LnlhaG9v
LmNvbYINYnJiLnlhaG9vLm5ldIIQYWRkLm15LnlhaG9vLmNvbYILKi55YWhvby5j
b22CDyoud3d3LnlhaG9vLmNvbYIRKi5tZWRpYS55YWhvby5jb22CGSouZ2xvYmFs
LnZlc3BhLm9hdGguY2xvdWSCDyouYXR0LnlhaG9vLmNvbYIOKi5hbXAueWltZy5j
b20wDgYDVR0PAQH/BAQDAgeAMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcD
AjB1BgNVHR8EbjBsMDSgMqAwhi5odHRwOi8vY3JsMy5kaWdpY2VydC5jb20vc2hh
Mi1oYS1zZXJ2ZXItZzYuY3JsMDSgMqAwhi5odHRwOi8vY3JsNC5kaWdpY2VydC5j
b20vc2hhMi1oYS1zZXJ2ZXItZzYuY3JsMD4GA1UdIAQ3MDUwMwYGZ4EMAQICMCkw
JwYIKwYBBQUHAgEWG2h0dHA6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzCBgwYIKwYB
BQUHAQEEdzB1MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20w
TQYIKwYBBQUHMAKGQWh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2Vy
dFNIQTJIaWdoQXNzdXJhbmNlU2VydmVyQ0EuY3J0MAkGA1UdEwQCMAAwggF9Bgor
BgEEAdZ5AgQCBIIBbQSCAWkBZwB2AOg+0No+9QY1MudXKLyJa8kD08vREWvs62nh
d31tBr1uAAABh9nmwMwAAAQDAEcwRQIgL+HM8l9bk3GKcgy2Dd3zAGHdna0ybQZQ
GmsvEwX58TcCIQDYqwMXMRrentSPwuk593MoPnslKVfLqePdwWUHJGRLpwB2ALNz
dwfhhFD4Y4bWBancEQlKeS2xZwwLh9zwAw55NqWaAAABh9nmwSYAAAQDAEcwRQIg
IhpCW9e04m2ki11BrwWgFi6m8MuFOIccN2+kREJMXP4CIQC2DP911vhghVWIMkdJ
1UPevjgqJsmIyf7ZnovXoHFwLgB1AHoyjFTYty22IOo44FIe6YQWcDIThU070ivB
OlejUutSAAABh9nmwMUAAAQDAEYwRAIgBgD7F5RatVyzlFFPbADrBqckIRnZYjDc
gIvI1ylO9m0CIFEedXbQft9sszsP/2/Uf0Plx3QhyqVK2xob2rTXspUTMA0GCSqG
SIb3DQEBCwUAA4IBAQBNrx7qDppLOKNDj90RlgCUFvPgTvfkEPp6R9XTmXcPE9LP
0r3EZxmik+1/GPZnOAQdC2z9L9/aM8Ir/GLH4igFMyhuJ3X9yiZ5CKX/naObqwNo
WrIUy3bMgkn1Mr+C4MDNNjLfOPtX+wsWsWmyzREwvyPXLZlvKtqLA46TOUNY6KgS
K8F056eue8ncG4zal1jV6B8PRdBSIH2cWJma4cdNcNY2cMlxiUUlEcJwXNEN+pSq
ivTndk4DNACoh0CqVK+fFnkNPlR3t0LefU7oc4bB6iEqqUGvhhmm53MvYGtHXdhS
ccR8O2EQZnVa2RKF9NRhQ5QgDa1EJpJlB+VPL7W+
-----END CERTIFICATE-----
</CODE></PRE></BLOCKQUOTE>

</BODY>
</HTML>

<!--  LocalWords:  MITM SSL PEM endian NTP CRC UTF DER sbl SHA secp
 -->
<!--  LocalWords:  lowerTimeDiffLimit upperTimeDiffLimit openssl GPG
 -->
<!--  LocalWords:  passwordTimeout keytool withECDSA BZDev decrypt
 -->
<!--  LocalWords:  EjwsSecureBasicAuth DNS APIs authenticator JRE
 -->
